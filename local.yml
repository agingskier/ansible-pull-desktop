---
# tasks to complete before running roles
- name: Pre-run to update package cache
  hosts: all
  connection: local
  tags: always
  become: true
  pre_tasks:
    - name: pre-run | update package cache Ubuntu
      tags: always
      apt:
        upgrade: yes
        update_cache: yes
      changed_when: false

# run roles
- name: Base role for all systems
  hosts: all
  tags: base
  become: true
  roles:
    - base

- name: Workstation role
  hosts: workstation
  tags: workstation
  become: true
  roles:
    - workstation


# - name: Server role
#  hosts: server
#  tags: server
#  become: true
#  roles:
#    - server

# end of run cleanup and reporting
- name: Cleanup and reporting
  hosts: all
  become: true

  tasks:
    - name: cleanup package cache Ubuntu
      tags: always
      apt:
        autoclean: true
      changed_when: false

    - name: autoremove orphan packages Ubuntu
      tags: always
      apt:
        autoremove: true
        purge: true

    - name: send completion alert
      include_tasks: playbooks/send_completion_alert.yml
      tags: always
      when:
        - task_failed is not defined

    - name: send failure alert
      include_tasks: playbooks/send_failure_alert.yml
      tags: always
      when:
        - task_failed is defined
#       - task_failed == true
