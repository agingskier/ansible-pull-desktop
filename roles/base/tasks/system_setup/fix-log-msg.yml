---
- name: System-setup | fix-log-msg block
  become: true
  become_method: sudo
  block:
    #
    # fix: Error message: systemd-udevd[447]: sdb3: Process '/usr/bin/unshare -m /usr/bin/snap auto-import 
    #                     --mount=/dev/sdb3' failed with exit code 1.
    - name: System-setup | fix-log-msg | delete file causing systemd-udevd snap auto-import errors
      ansible.builtin.file:
        path: /lib/udev/rules.d/66-snapd-autoimport.rules
        owner: root
        group: root
        mode: 0644
        state: absent

    #
    # fix: Error message: kernel: IPv6: MLD: clamping QRV from 1 to 2!
    #
    - name: System-setup | fix-log-msg | create 10-ipv6-mld.conf file in /etc/sysctl.d
      ansible.builtin.copy:
        dest: "/etc/sysctl.d/95-ipv6-mld.conf"
        content: |
          #
          # kernel: IPv6: MLD: clamping QRV from 1 to 2! (lots of these messages in journalctl)
          #
          net.ipv6.mld_qrv = 1
        owner: root
        group: root
        mode: 0644
        
    #
    # fix Spam snap messages in journal:
    #  ... audit[97745]: SECCOMP auid=1000 uid=1000 gid=1000 ses=3 subj=? pid=97745 comm="CanvasRenderer"
    #  ... exe="/snap/firefox/1775/usr/lib/firefox/firefox"
    #
    - name: System-setup | fix-log-msg | avoid spam messages SECCOMP from snap firefox
      ansible.builtin.apt:
        state: present
        pkg:
          - auditd

    - name: System-setup | fix-log-msg | create snap firefox rules file
      ansible.builtin.copy:
        dest: "/etc/audit/rules.d/firefox.rules
        content: |
          #
          # spam SECCOMP snap firefox messages
          @
          -a never,exclude -F exe=/snap/firefox/current/usr/lib/firefox/firefox
        owner: root
        group: root
        mode: 0644
      notify: Restart_auditd
      
    - name: System-setup | fix-log-msg | verify if firefox rules are active
      ansible.builtin.command: auditctl -l
      register: audit_cmd
      changed_when: autid_cmd.rc == 0  
