---
- name: System-setup | fix-log-msg block
  become: true
  become_method: ansible.builtin.sudo
  block:
    #
    # fix: Error message: systemd-udevd[447]: sdb3: Process '/usr/bin/unshare -m /usr/bin/snap auto-import 
    #                     --mount=/dev/sdb3' failed with exit code 1.
    - name: System-setup | fix-log-msg | delete file causing systemd-udevd snap auto-import errors
      ansible.builtin.file:
        path: /lib/udev/rules.d/66-snapd-autoimport.rules
        owner: root
        group: root
        mode: 0644
        state: absent

    #
    # fix: Error message: kernel: IPv6: MLD: clamping QRV from 1 to 2!
    #
    - name: System-setup | fix-log-msg | create 10-ipv6-mld.conf file in /etc/sysctl.d
      ansible.builtin.copy:
        path: "/etc/sysctl.d/95-ipv6-mld.conf"
        content: |
          #
          # kernel: IPv6: MLD: clamping QRV from 1 to 2! (lots of these messages in journalctl)
          #
          net.ipv6.mld_qrv = 1
        owner: root
        group: root
        mode: 0644

    #
    # fix: Shutdown too slow, reduce stop timeout value - Reboot required
    #
    - name: System-setup | fix-log-msg | change system.conf entry to speed up shutdown
      ansible.builtin.lineinfile:
        path: "/etc/systemd/system.conf"
        regex: "^#DefaultTimeoutStopSec=90s"
        line: "DefaultTimeoutStopSec=10s"
        owner: root
        group: root
        mode: 0644

    - name: Software | sssd | create sssd directory
      become: true
      become_user: root
      ansible.builtin.file:
        path: /var/log/sssd
        state: directory
        owner: sssd
        group: sssd
        mode: 0774

    #
    # fix: Error message: systemd[1]: Dependency failed for sssd-ssh.socket - SSSD SSH Service responder socket.
    #
    - name: System-setup | fix-log-msg | copy sssd.conf to /etc/sssd/conf.d directory
      ansible.builtin.copy:
        src: /usr/lib/x86_64-linux-gnu/sssd/conf/sssd.conf
        dest: /etc/sssd/conf.d/sssd.conf
        owner: root
        group: root
        mode: 0644

    #
    # fix: Error message: bluetoothd[1674]: profiles/sap/server.c:sap_server_register() Sap driver initialization failed.
    #
    - name: System-setup | fix-log-msg | change ExecStart line with option --noplugin=sap
      ansible.builtin.lineinfile:
        path: /usr/lib/systemd/system/bluetooth.service
        regex: "^ExecStart="
        line: "ExecStart=/usr/libexec/bluetooth/bluetoothd --noplugin=sap"
        owner: root
        group: root
        mode: 0644
