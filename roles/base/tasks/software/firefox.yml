---
- name: software | firefox block
  block:
  
    - name: software | firefox | remove snap firefox
      snap:
        name: firefox
        state: absent

    - name: software | firefox | add firefox apt repository
      apt_repository:
        filename: firefox
        repo: 'ppa:mozillateam/ppa'
        state: present
        update_cache: yes

# run "sudo apt-key list" to find the full public gpg key
# use the last 8 characters for the export command

    - name: software | firefox | apt-key deprecated - convert trusted.gpg into member in tursted.gpg.d
      shell: |
        set -o pipefail
        apt-key export CE49EC21 | \
        gpg --dearmour -o /etc/apt/trusted.gpg.d/mozilla.gpg
      args:
        warn: false
        executable: /bin/bash
      register: gpg_convert
      changed_when: gpg_convert.rc == 0

    - name: software | firefox | create apt file to avoid reinstall of snap firefox
      copy:
        dest: "/etc/apt/preferences.d/mozilla-firefox"
        owner: root
        group: root
        mode: 0644
        content: |
          Package: *
          Pin: release o=LP-PPA-mozillateam
          Pin-Priority: 1001

    - name: software | firefox | ensure automatic updates of apt firefox
      copy:
        dest: "/etc/apt/apt.conf.d/51unattended-upgrades-firefox"
        owner: root
        group: root
        mode: 0644
        content: |
          Unattended-Upgrade::Allowed-Origins:: "LP-PPA-mozillateam:${distro_codename}";

    - name: software | firefox | install firefox
      apt:
        pkg:
          - firefox

  become: yes
  become_method: sudo
