---
- name: software | tmux | install tmux package
  apt:
    state: present
    pkg:
      - tmux

- name: software | tmux | create .tmux directories
  file:
    path: /home/bernhard/{{ item.dir }}
    state: directory
    owner: bernhard
    group: users
    mode: 0700
  with_items:
    - { dir: '.tmux' }
    - { dir: '.tmux/plugins' }

- name: software | tmux | git checkout git tmux plugins
  git:
    repo: https://github.com/tmux-plugins/{{ item.repo }}
    dest: /home/bernhard/.tmux/plugins/{{ item.plug }}
    force: yes
    version: master
  with_items:
    - { repo: 'tmux-cpu.git', plug: 'tmux-cpu' }
    - { repo: 'tmux-prefix-highlight.git', plug: 'tmux-prefix-highlight' }
    - { repo: 'tmux-yank.git', plug: 'tmux-yank' }
    - { repo: 'tmux-sidebar.git', plug: 'tmux-sidebar' }
    - { repo: 'tmux-open.git', plug: 'tmux-open' }

- name: software | tmux | recursively chown all tmux plugins files
  file:
    path: /home/bernhard/.tmux/plugins
    state: directory
    owner: bernhard
    group: users
    mode: 0755
    recurse: yes

- name: software | tmux | Download latest release gitmux info
  shell: |
    set -o pipefail &&
    curl --silent "https://api.github.com/repos/arl/gitmux/releases/latest" |
    grep '"tag_name":' |
    sed -E 's/.*"([^"]+)".*/\1/'
  args:
    warn: false
  register: gitmux_release
  changed_when: gitmux_release.rc == 0

- name: software | tmux | print gitmux_release
  debug:
    var: gitmux_release
    verbosity: 2

# extract version number without "v" from variable gitmux_release
- name: software | tmux | install binary gitmux
  become: true
  become_method: sudo
  unarchive:
    src: https://github.com/arl/gitmux/releases/download/{{ gitmux_release }}/gitmux_{{ gitmux_release | regex_search('(\d(.*))') }}_linux_amd64.tar.gz
    dest: /usr/local/bin
    remote_src: yes
    mode: 0755
    owner: root
    group: root

- name: software | tmux | create gitmux configuration file
  command: gitmux -printcfg
  register: gitmux_config
  changed_when: gitmux_config.rc == 0

- name: software | tmux | write gitmux.conf file
  copy:
    content: "{{ gitmux_config.stdout }}"
    dest: /home/bernhard/.gitmux.conf
    owner: bernhard
    group: users
    mode: 0644
